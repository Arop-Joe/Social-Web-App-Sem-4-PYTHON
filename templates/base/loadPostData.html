{% load static %}
<script>

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#viewImageupd').attr('src', e.target.result)
                $('#viewImageupd').css('display','block');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function wipeUpd(){
        $('#viewImageupd').css('display','none');
        $("#modalImageupd").val(null);
    }

    function loadPostData(formID){
            var typingTimer;
            var doneInterval=300; //ms
            var searchInput=$("#search input[type=text]")
            var searchQuery;

            var postContainer
            if (formID){
                postContainer=$("#"+formID)
            }else{
                var postContainer=$("#post-container")
            }
            var initialURL=postContainer.attr("data-url") || "/post/api/"
            console.log(initialURL)


            searchInput.keyup(function(event){
                searchQuery=$(this).val()
                clearTimeout(typingTimer)
                typingTimer=setTimeout(doneSearchTyping,doneInterval)
            })

            searchInput.keydown(function(event){
                clearTimeout(typingTimer)
            })

            function doneSearchTyping(){
                if(searchQuery){
                    var url='/post/?q='+searchQuery
                    document.location.href=url;
                }
            }

            var query=getParameterByName('q')
            var postList=[];
            var nextPostURL;

            function updateHashLinks(){
                $(".posts").each(function(data){
                    var hashTagRegex= /(^|\s)*#([\w\d-]+)/g
                    var usernameRegex= /(^|\s)*@([\w\d-]+)/g
                    var currentHtml=$(this).html()
                    var newText
                    newText=currentHtml.replace(hashTagRegex,
                        "$1<a href='/tags/$2/' style='text-decoration:none;'>#$2</a>")
                    newText=newText.replace(usernameRegex,
                        "$1<a href='/profile/$2/' style='text-decoration:none;'>@$2</a>")
                    $(this).html(newText)

                })
            }


            var postIDdel
            var postContentdel
            var postUserdel
            $(document.body).on("click",".post-del",function(e){
                e.preventDefault()
                var this_=$(this)
                postIDdel=this_.attr("data-id")
                postContentdel=document.getElementById('postContent'+postIDdel).innerHTML
                document.getElementById('modalContentdel').innerHTML=postContentdel
                postUserdel=document.getElementById('postUser'+postIDdel).innerHTML
                document.getElementById('modalUserdel').innerHTML=postUserdel
                console.log(postIDdel)
                var delURL="/post/api/"+postIDdel+"/delete/"
                $("#delform").attr("href", delURL)
                document.getElementById('modalTitledel').innerHTML="Delete"
                $('#deleteModal').modal('show');

            });
            $('#delform').submit(function(event){
                event.preventDefault()
                var this_=$(this)
                console.log(postIDdel)
                var divID="post-"+postIDdel
                var delURL="/post/api/"+postIDdel+"/delete/"
                var formData=this_.serializeArray();
                var formDataJSON = {};
                $.map(formData, function(n, i){
                    formDataJSON[n['name']] = n['value'];
                });
                console.log(formDataJSON)
                formDataJSON['pk']=postIDdel
                console.log(formDataJSON)
                $.ajax({
                    method: "DELETE",
                    url: delURL,
                    data: formDataJSON,
                    success: function(data){
                        console.log("Deleted")
                        $('#deleteModal').modal('hide');
                        console.log(divID)
                        document.getElementById(divID).remove();
                    },
                    error: function(data){
                        console.log("error")
                        document.getElementById('modalTitledel').innerHTML="<span style='color:red'>Permission Denied!</span>"
                        console.log(data)
                    },
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                })
            });

            var postIDupd
            var postContentupd
            var postUserupd
            $(document.body).on("click",".post-upd",function(e){
                e.preventDefault()
                var this_=$(this)
                postIDupd=this_.attr("data-id")
                console.log(postIDupd)
                postContentupd=document.getElementById('postContent'+postIDupd).innerHTML
                postContentupd = postContentupd.replace(/<\/?[^>]+(>|$)/g, "");
                document.getElementById('modalContentupd').innerHTML=postContentupd
                var updURL="/post/api/"+postIDdel+"/delete/"
                $("#updform").attr("href", updURL)
                document.getElementById('modalTitleupd').innerHTML="Update"
                $('#updateModal').modal('show');
            });
            $('#updform').submit(function(event){
                event.preventDefault()
                var this_=$(this)
                console.log(postIDupd)
                var divID="post-"+postIDupd
                var updURL="/post/api/"+postIDupd+"/update/"
                var imageID = $('#modalImageupd');
                var formData = new FormData(imageID.closest('form').get(0));    
                formData.append('pk',postIDupd)
                formData.append('content',document.getElementById('modalContentupd').value)
                for (var pair of formData.entries()) {
                    console.log(pair[0]+ ', ' + pair[1]); 
                }
                $.ajax({
                    method: "PUT",
                    url: updURL,
                    data: formData,
                    async: true,
                    cache: false,
                    contentType: false,
                    enctype: 'multipart/form-data',
                    processData: false,
                    success: function(data){
                        console.log("Updated")
                        $('#updateModal').modal('hide');
                        console.log(divID)
                        document.getElementById('post-container').innerHTML=""
                        fetchPost()
                        $('#viewImageupd').css('display','none');
                        $("#modalImageupd").val(null);
                    },
                    error: function(data){
                        console.log("error")
                        document.getElementById('modalTitleupd').innerHTML="<span style='color:red'>Permission Denied!</span>"
                        console.log(data)
                        $('#viewImageupd').css('display','none');
                        $("#modalImageupd").val(null);
                    },
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                })
            });


            $(document.body).on("click",".post-like",function(e){
                e.preventDefault()
                var this_=$(this)
                var postID=this_.attr("data-id")
                var postIDname="post"+postID
                console.log(postIDname)
                var likedURL="/post/api/"+postID+"/like/"
                //this_.text("Liked")
                document.getElementById(postIDname).innerHTML='favorite'
                $.ajax({
                    method: "GET",
                    url: likedURL,
                    success: function(data){
                        if(data.liked){
                            //this_.text("Liked")
                            console.log("Liked")
                            document.getElementById(postIDname).innerHTML='favorite'
                        }else{
                            console.log("Unliked")
                            //this_.text("Unliked")
                            document.getElementById(postIDname).innerHTML='favorite_border'
                        }
                    },
                    error: function(data){
                        console.log("error")
                        console.log(data)
                    }
                })
            })

            function attachPost(postValue,prepend){
                var postContent=postValue.content;
                var postTimeSince=postValue.timesince;
                var postUser=postValue.user;
                var is_liked='favorite_border'
                var postDropDown
                if(postValue.did_like){
                    is_liked='favorite'
                }
                var postURL=postValue.get_absolute_url;
                var postUserImage=postValue.user.profile.image
                if (postUserImage === null || postUserImage === undefined) {
                    postUserImage="{% static 'images/profile.png' %}";
                }
                if(postUser.id==postUser.current_user){
                    postDropDown="<span style='float: right;'><a data-toggle='dropdown'><img src='{% static 'images/more-24.png' %}'></a>"+
                                        "<div class='dropdown-menu dropdown-menu-right'>"+
                                        "<small><a class='dropdown-item post-upd' data-id='"+postValue.id+"'>Update</a></small>"+
                                        "<small><a class='dropdown-item post-del' data-id='"+postValue.id+"'>Delete</a></small>"+
                                    "</div></span>"
                }else{
                    postDropDown=""
                }
                if(postValue.image === null || postValue.image === undefined){
                    postImage=""
                }else{
                    postImage="<img src=\'"+postValue.image+"\' id='postImage"+postValue.id+"' />"
                }
                var imageFormattedHTML="<img src=\'"+postUserImage+"\' alt=\'"+postUser.first_name+" "+postUser.last_name+
                        "\'  style=\"width:25px;float: left;\" class=\"border  rounded-circle border-white\" />"
                var postFormattedHTML=
                    //"<div style='box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)'>"+
                         "<div id='post-"+postValue.id+"'><div class='card posts' style='width: 45rem;'>"+
                              "<div class='card-body'>"+
                                "<h5 class='card-title'><a href='"+postUser.url+"' style='text-decoration:none;' id='postUser"+postValue.id+"'>"+imageFormattedHTML+" "+postUser.username+"</a>"+
                                postDropDown+"</h5>"+
                                "<small class='card-subtitle mb-2 text-muted' ><a href='"+postURL+"' style='color:black;text-decoration:none;' id='postTime"+postValue.id+"'>"+postTimeSince+"</a></small>"+
                                "<p class='card-text' id='postContent"+postValue.id+"'>"+postContent+"</p>"+
                                postImage+
                                //"<a href='#' class='card-link post-like' >"+is_liked+"("+postValue.likes+")</a>"+
                                "<button id='post"+postValue.id+"' class='mdc-icon-button material-icons text-danger post-like' data-id='"+postValue.id+"'>"+is_liked+"</button>"+
                                //"<div ></div>"+
                              "</div>"+
                             // "<button class='mdc-icon-button material-icons post-like' data-id='"+postValue.id+"'>share</button>"+
                             "</div><br></div>"
                if(prepend==true){
                    postContainer.prepend(postFormattedHTML)
                }else{
                    postContainer.append(postFormattedHTML)
                }
            }

            function parsePost(){
                //initialContainer.empty();
                if(postList==0){
                    postContainer.text("No Posts currently found!")
                }else{
                    $.each(postList,function(key,value){
                        var postKey=key;
                        //console.log(postKey)
                        //console.log(value)
                        attachPost(value)
                    })
                }
            }


            function fetchPost(url){
                console.log("fetching...");
                var fetchURL;
                if(!url){
                    fetchURL=initialURL

                }else{
                    fetchURL=url
                }

                $.ajax({
                    url: fetchURL,
                    data: {
                        "q": query
                    },
                    method: "GET",
                    success: function(data){
                        if(data.results){
                            postList=data.results
                            if(data.next){
                                nextPostURL=data.next
                            }else{
                                $("#load_more_posts").css("display","none")
                            }
                            parsePost()
                        }else{
                            postList=data
                            attachPost(postList)
                            $("#load_more_posts").css("display","none")
                        }
                        //console.log(postList)
                        updateHashLinks()
                    },
                    error: function(data){
                        console.log("ERROR")
                        console.log(data)
                    },
                })
            }
            fetchPost()


            $("#load_more_posts").click(function(event){
                event.preventDefault()
                if(nextPostURL){
                    fetchPost(nextPostURL)
                }
            })

            var postStart=500
            var postCurrent=0
            $('#postChar').html("500")
            $('#post-form textarea').keydown(function(event){
                var postValue=$(this).val()
                postCurrent=postStart-postValue.length
                $('#postChar').text(postCurrent)
                if (event.keyCode != 8 && event.keyCode != 46 && postCurrent === 0) {
                    event.preventDefault();
                } else if (event.keyCode != 8 && event.keyCode != 46 && postCurrent < 0) {
                    event.preventDefault();
                    $(this).val(postValue.substring(1,postStart))
                }
            })           
            $('#post-form').submit(function(event){
                event.preventDefault()
                var this_=$(this)
                var imageID = $('#id_image');
                var formData = new FormData(imageID.closest('form').get(0));
                console.log(formData)
                for (var pair of formData.entries()) {
                    console.log(pair[0]+ ', ' + pair[1]); 
                }
                $.ajax({
                    url: "/post/api/create/",
                    data: formData,
                    method: "POST",
                    async: true,
                    cache: false,
                    contentType: false,
                    enctype: 'multipart/form-data',
                    processData: false,
                    success: function(data){
                        this_.find("input[type=text],textarea").val("")
                        attachPost(data,true)
                        updateHashLinks()
                        //fetchPost()
                    },
                    error: function(data){
                        console.log("ERROR")
                        console.log(data)
                        console.log(data.status)
                    },
                })
            })
        }
</script>
<!--"<div class=\'posts\'><h5>"+"<a href='"+postUser.url+"'>"+-->
                        <!--imageFormattedHTML+postUser.username+"</a></h5>"+-->
                        <!--postContent+"<br>"+-->
                        <!--postTimeSince+"<br>"+-->
                        <!--"<a href='#' class='post-like' data-id='"+postValue.id+"'>"+is_liked+"("+postValue.likes+")</a> | "+-->
                        <!--"<a href='"+postURL+"'>View</a> | "+-->
                        <!--"<a href='"+postURL+"edit'>Update</a> | "+-->
                        <!--"<a href='"+postURL+"delete'>Delete</a>"+-->
                        <!--"</div><hr>"-->